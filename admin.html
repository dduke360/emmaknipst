<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Emma Knipst</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“·</text></svg>">
  <link rel="stylesheet" href="style.css">
  <style>
    :root {
      --admin-bg: #f2f2f7;
      --admin-surface: rgba(255, 255, 255, 0.92);
      --admin-surface-strong: #ffffff;
      --admin-text: #111114;
      --admin-muted: #6b6b73;
      --admin-border: rgba(17, 17, 20, 0.08);
      --admin-accent: #0a84ff;
      --admin-danger: #ff375f;
      --admin-success: #30d158;
      --admin-radius-lg: 22px;
      --admin-radius-md: 16px;
      --admin-radius-sm: 12px;
      --admin-shadow: 0 18px 40px rgba(25, 28, 35, 0.08);
    }

    [data-theme="dark"] {
      --admin-bg: #0a0a0d;
      --admin-surface: rgba(28, 28, 30, 0.9);
      --admin-surface-strong: #1c1c1e;
      --admin-text: #f5f5f7;
      --admin-muted: #a1a1aa;
      --admin-border: rgba(245, 245, 247, 0.12);
      --admin-accent: #64d2ff;
      --admin-danger: #ff6482;
      --admin-success: #4ee082;
      --admin-shadow: 0 20px 44px rgba(0, 0, 0, 0.42);
    }

    .admin-body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--admin-bg);
      color: var(--admin-text);
    }

    .admin-container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.2rem 1rem 2rem;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.95rem 1rem;
      border: 1px solid var(--admin-border);
      background: var(--admin-surface);
      border-radius: var(--admin-radius-lg);
      box-shadow: var(--admin-shadow);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .admin-header h1 {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      font-size: 1.04rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .header-actions {
      display: flex;
      gap: 0.55rem;
      align-items: center;
    }

    .btn {
      border: 1px solid var(--admin-border);
      border-radius: 999px;
      padding: 0.5rem 0.86rem;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      line-height: 1;
      font-family: inherit;
      transition: 180ms ease;
      background: var(--admin-surface);
      color: var(--admin-text);
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-primary {
      background: var(--admin-accent);
      color: #fff;
      border-color: var(--admin-accent);
    }

    .btn-secondary {
      background: var(--admin-surface-strong);
    }

    .btn-danger {
      background: transparent;
      color: var(--admin-danger);
      border-color: color-mix(in srgb, var(--admin-danger) 50%, var(--admin-border));
    }

    .btn-success {
      background: transparent;
      color: var(--admin-success);
      border-color: color-mix(in srgb, var(--admin-success) 50%, var(--admin-border));
    }

    .full-width {
      width: 100%;
      justify-content: center;
    }

    .theme-toggle-admin {
      min-width: 5rem;
    }

    .admin-section {
      background: var(--admin-surface);
      padding: 1rem;
      margin-bottom: 1.05rem;
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-lg);
      box-shadow: var(--admin-shadow);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .admin-section h2 {
      font-size: 0.95rem;
      margin-bottom: 0.7rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .section-note {
      font-size: 0.8rem;
      color: var(--admin-muted);
      margin-bottom: 0.9rem;
    }

    .form-group {
      margin-bottom: 0.85rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.8rem;
      color: var(--admin-muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea,
    .control-field {
      width: 100%;
      padding: 0.58rem 0.72rem;
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-sm);
      font-size: 0.86rem;
      background: var(--admin-surface-strong);
      color: var(--admin-text);
      font-family: inherit;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(148px, 1fr));
      gap: 0.7rem;
    }

    .photo-card {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-md);
      background: var(--admin-surface-strong);
    }

    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-card .delete-btn {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(0, 0, 0, 0.52);
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    .stats-card {
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-md);
      padding: 0.75rem;
      background: var(--admin-surface-strong);
    }

    .stat-title {
      color: var(--admin-muted);
      font-size: 0.74rem;
      margin-bottom: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .stats-row {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.48rem 0;
      border-bottom: 1px solid var(--admin-border);
      font-size: 0.83rem;
    }

    .stats-row:last-child {
      border-bottom: none;
    }

    .stat-rank {
      width: 20px;
      color: var(--admin-muted);
    }

    .stat-thumb {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      object-fit: cover;
    }

    .stat-name {
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .stat-value {
      color: var(--admin-muted);
    }

    .stat-value-like {
      color: var(--admin-accent);
    }

    .category-form {
      display: flex;
      gap: 0.55rem;
      align-items: flex-end;
    }

    .category-input-group {
      margin-bottom: 0;
      flex: 1;
    }

    .category-list {
      margin-top: 0.8rem;
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--admin-border);
      background: var(--admin-surface-strong);
      font-size: 0.75rem;
      margin: 0.18rem;
      gap: 0.35rem;
    }

    .category-remove {
      border: none;
      background: transparent;
      color: var(--admin-muted);
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .upload-preview {
      max-width: 200px;
      max-height: 150px;
      object-fit: contain;
      margin-bottom: 0.5rem;
      border-radius: 10px;
      border: 1px solid var(--admin-border);
    }

    .upload-success {
      font-size: 0.83rem;
      color: var(--admin-success);
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .login-box {
      background: var(--admin-surface);
      padding: 1.35rem;
      border: 1px solid var(--admin-border);
      width: 100%;
      max-width: 380px;
      color: var(--admin-text);
      border-radius: var(--admin-radius-lg);
      box-shadow: var(--admin-shadow);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .login-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.1rem;
    }

    .login-box h1 {
      margin: 0;
      font-size: 1.08rem;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      font-weight: 700;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 860px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 620px) {
      .admin-container {
        padding: 0.9rem 0.65rem 1.5rem;
      }

      .admin-header {
        flex-direction: column;
        gap: 0.7rem;
        align-items: flex-start;
      }

      .category-form {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body class="admin-body">
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <div class="login-header">
        <h1>Admin Login</h1>
        <button id="theme-toggle-login" type="button" class="btn btn-secondary theme-toggle-admin">Dark</button>
      </div>
      <form id="login-form">
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" class="btn btn-primary full-width">Login</button>
      </form>
    </div>
  </div>

  <div id="admin-app" class="admin-container hidden">
    <div class="admin-header">
      <h1>Photo Admin</h1>
      <div class="header-actions">
        <button id="theme-toggle-admin" type="button" class="btn btn-secondary theme-toggle-admin">Dark</button>
        <button id="logout-btn" class="btn btn-secondary">Logout</button>
      </div>
    </div>

    <div class="admin-section">
      <h2>Upload to Cloudinary</h2>
      <p class="section-note">Upload images to Cloudinary (free cloud storage). Images persist across deployments.</p>
      <div id="cloudinary-uploads" class="category-list"></div>
      <button id="cloudinary-upload-btn" class="btn btn-primary">Upload Image</button>
      <div id="cloudinary-form" class="category-list" style="display: none;">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="cloudinary-title" placeholder="Photo title">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="cloudinary-category"></select>
        </div>
        <button id="add-cloudinary-btn" class="btn btn-success">Add to Gallery</button>
      </div>
    </div>

    <div class="admin-section">
      <h2>Statistics</h2>
      <div class="stats-grid">
        <div class="stats-card">
          <h3 class="stat-title">Top 10 by Views</h3>
          <div id="top-views"></div>
        </div>
        <div class="stats-card">
          <h3 class="stat-title">Top 10 by Likes</h3>
          <div id="top-likes"></div>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <h2>Manage Categories</h2>
      <form id="add-category-form" class="category-form">
        <div class="form-group category-input-group">
          <label>New Category Name</label>
          <input type="text" id="new-category" placeholder="Category name">
        </div>
        <button type="submit" class="btn btn-secondary">Add</button>
      </form>
      <div id="category-list" class="category-list"></div>
    </div>

    <div class="admin-section">
      <h2>All Photos</h2>
      <div id="photos-grid" class="photos-grid"></div>
    </div>

    <div class="admin-section">
      <h2>Edit About</h2>
      <form id="about-form">
        <div class="form-group">
          <label>About Text</label>
          <textarea id="about-text" rows="4" class="control-field"></textarea>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="about-email">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="about-instagram">
        </div>
        <button type="submit" class="btn btn-primary">Save About</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const THEME_KEY = 'emma_theme';
    const ADMIN_PASSWORD = 'emma2026';
    let data = null;
    let cloudinaryUploadedUrl = null;

    // Cloudinary config
    const CLOUDINARY_CLOUD_NAME = 'djoh49z3m';
    const CLOUDINARY_UPLOAD_PRESET = 'emmaknipst';

    const loginScreen = document.getElementById('login-screen');
    const adminApp = document.getElementById('admin-app');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const addCategoryForm = document.getElementById('add-category-form');
    const photosGrid = document.getElementById('photos-grid');
    const categoryList = document.getElementById('category-list');
    const themeToggleLogin = document.getElementById('theme-toggle-login');
    const themeToggleAdmin = document.getElementById('theme-toggle-admin');

    setupTheme();

    function setupTheme() {
      const storedTheme = localStorage.getItem(THEME_KEY);
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = storedTheme || (prefersDark ? 'dark' : 'light');
      applyTheme(initialTheme);

      [themeToggleLogin, themeToggleAdmin].forEach(toggle => {
        if (!toggle) return;
        toggle.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-theme') || 'light';
          const next = current === 'dark' ? 'light' : 'dark';
          applyTheme(next);
          localStorage.setItem(THEME_KEY, next);
        });
      });
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const label = theme === 'dark' ? 'Light' : 'Dark';
      [themeToggleLogin, themeToggleAdmin].forEach(toggle => {
        if (!toggle) return;
        toggle.textContent = label;
        toggle.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
      });
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      if (password === ADMIN_PASSWORD) {
        loginScreen.classList.add('hidden');
        adminApp.classList.remove('hidden');
        loadData();
      } else {
        alert('Incorrect password');
      }
    });

    logoutBtn.addEventListener('click', () => {
      loginScreen.classList.remove('hidden');
      adminApp.classList.add('hidden');
      document.getElementById('password').value = '';
    });

    async function loadData() {
      try {
        // Load photos from Supabase
        const { data: photos, error: photosError } = await supabaseClient
          .from('photos')
          .select('*')
          .order('created_at', { ascending: false });

        if (photosError) throw photosError;

        // Load settings from Supabase
        const { data: settings, error: settingsError } = await supabaseClient
          .from('settings')
          .select('*');

        if (settingsError) throw settingsError;

        // Convert settings to photographer object
        const settingsObj = {};
        settings.forEach(s => {
          settingsObj[s.key] = s.value;
        });

        data = {
          photographer: {
            about: settingsObj.about || '',
            email: settingsObj.email || '',
            instagram: settingsObj.instagram || ''
          },
          categories: [
            { id: 'portraits', name: 'Portraits' },
            { id: 'fashion', name: 'Fashion' },
            { id: 'lifestyle', name: 'Lifestyle' },
            { id: 'nature', name: 'Nature' }
          ],
          photos: photos || []
        };

        // Also save to localStorage as backup
        localStorage.setItem('emma_photos', JSON.stringify(data));

        render();
      } catch (error) {
        console.error('Failed to load from Supabase:', error);
        // Fallback to localStorage
        const stored = localStorage.getItem('emma_photos');
        if (stored) {
          data = JSON.parse(stored);
          render();
        } else {
          alert('Failed to load data. Check console for details.');
        }
      }
    }

    async function savePhoto(photo, action = 'insert') {
      try {
        if (action === 'delete') {
          const { error } = await supabaseClient.from('photos').delete().eq('id', photo.id);
          if (error) throw error;
        } else if (action === 'insert') {
          const { error } = await supabaseClient.from('photos').insert([{
            title: photo.title,
            src: photo.src,
            category: photo.category
          }]);
          if (error) throw error;
        }
        
        // Reload data after save
        await loadData();
      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save. Check console for details.');
      }
    }

    async function saveSetting(key, value) {
      try {
        const { error } = await supabaseClient
          .from('settings')
          .upsert({ key, value }, { onConflict: 'key' });
        
        if (error) throw error;
      } catch (error) {
        console.error('Save setting error:', error);
      }
    }

    async function saveData() {
      // Save to localStorage as immediate feedback
      localStorage.setItem('emma_photos', JSON.stringify(data));
      render();
    }

    function render() {
      renderCategories();
      renderPhotos();
      renderAboutForm();
      renderStats();
    }

    function renderStats() {
      const photos = data.photos || [];
      
      // Sort by views
      const byViews = [...photos].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 10);
      // Sort by likes
      const byLikes = [...photos].sort((a, b) => (b.likes || 0) - (a.likes || 0)).slice(0, 10);
      
      document.getElementById('top-views').innerHTML = byViews.map((p, i) => `
        <div class="stats-row">
          <span class="stat-rank">${i + 1}.</span>
          <img class="stat-thumb" src="${p.src}" alt="${p.title}">
          <span class="stat-name">${p.title}</span>
          <span class="stat-value">${p.views || 0} views</span>
        </div>
      `).join('');
      
      document.getElementById('top-likes').innerHTML = byLikes.map((p, i) => `
        <div class="stats-row">
          <span class="stat-rank">${i + 1}.</span>
          <img class="stat-thumb" src="${p.src}" alt="${p.title}">
          <span class="stat-name">${p.title}</span>
          <span class="stat-value stat-value-like">â™¥ ${p.likes || 0}</span>
        </div>
      `).join('');
    }

    function renderCategories() {
      categoryList.innerHTML = '';
      document.getElementById('cloudinary-category').innerHTML = '';
      
      data.categories.forEach(cat => {
        const tag = document.createElement('span');
        tag.className = 'category-tag';
        tag.innerHTML = `${cat.name} <button class="category-remove" onclick="deleteCategory('${cat.id}')">&times;</button>`;
        categoryList.appendChild(tag);

        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        document.getElementById('cloudinary-category').appendChild(option);
      });
    }

    function renderPhotos() {
      photosGrid.innerHTML = '';
      data.photos.forEach(photo => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
          <img src="${photo.src}" alt="${photo.title}">
          <button class="delete-btn" onclick="deletePhoto(${photo.id})">&times;</button>
        `;
        photosGrid.appendChild(card);
      });
    }

    function renderAboutForm() {
      document.getElementById('about-text').value = data.photographer.about || '';
      document.getElementById('about-email').value = data.photographer.email || '';
      document.getElementById('about-instagram').value = data.photographer.instagram || '';
    }

    document.getElementById('about-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const about = document.getElementById('about-text').value;
      const email = document.getElementById('about-email').value;
      const instagram = document.getElementById('about-instagram').value;
      
      // Save to Supabase
      await saveSetting('about', about);
      await saveSetting('email', email);
      await saveSetting('instagram', instagram);
      
      // Update local data
      data.photographer.about = about;
      data.photographer.email = email;
      data.photographer.instagram = instagram;
      localStorage.setItem('emma_photos', JSON.stringify(data));
      
      alert('About saved to cloud!');
    });

    addCategoryForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('new-category').value.trim();
      if (name) {
        const id = name.toLowerCase().replace(/\s+/g, '-');
        if (!data.categories.find(c => c.id === id)) {
          data.categories.push({ id, name });
          saveData();
        }
        document.getElementById('new-category').value = '';
      }
    });

    window.deletePhoto = async (id) => {
      if (confirm('Delete this photo?')) {
        const photo = data.photos.find(p => p.id === id);
        if (photo) {
          await savePhoto(photo, 'delete');
        }
      }
    };

    window.deleteCategory = (id) => {
      if (confirm('Delete this category? Photos will need a new category.')) {
        data.categories = data.categories.filter(c => c.id !== id);
        saveData();
      }
    };

    // Cloudinary upload functionality
    const cloudinaryUploadBtn = document.getElementById('cloudinary-upload-btn');
    const cloudinaryForm = document.getElementById('cloudinary-form');
    const cloudinaryTitle = document.getElementById('cloudinary-title');
    const addCloudinaryBtn = document.getElementById('add-cloudinary-btn');

    function openCloudinaryWidget() {
      if (typeof cloudinary === 'undefined') {
        alert('Cloudinary widget not loaded. Check console (F12) for errors.');
        return;
      }

      if (CLOUDINARY_CLOUD_NAME === 'YOUR_CLOUD_NAME' || CLOUDINARY_UPLOAD_PRESET === 'YOUR_UPLOAD_PRESET') {
        alert('Please configure Cloudinary in admin.html. See instructions in CLOUDINARY_SETUP.md');
        return;
      }

      try {
        cloudinary.openUploadWidget({
        cloud_name: CLOUDINARY_CLOUD_NAME,
        upload_preset: CLOUDINARY_UPLOAD_PRESET,
        sources: ['local', 'url', 'camera'],
        multiple: false,
        folder: 'emma_knipst'
      }, (error, result) => {
        if (error) {
          console.error('Cloudinary error:', error);
          alert('Upload failed. Check console for details.');
          return;
        }
        if (result && result.event === 'success') {
          cloudinaryUploadedUrl = result.info.secure_url;
          document.getElementById('cloudinary-uploads').innerHTML = `
            <img src="${cloudinaryUploadedUrl}" alt="Uploaded preview" class="upload-preview">
            <p class="upload-success">Uploaded successfully!</p>
          `;
          cloudinaryForm.style.display = 'block';
          cloudinaryTitle.value = result.info.original_filename || 'Untitled';
        }
      });
      } catch (e) {
        console.error('Widget error:', e);
        alert('Error opening widget: ' + e.message);
      }
    }

    cloudinaryUploadBtn.addEventListener('click', openCloudinaryWidget);

    addCloudinaryBtn.addEventListener('click', async () => {
      if (!cloudinaryUploadedUrl) return;
      
      const title = cloudinaryTitle.value.trim() || 'Untitled';
      const category = document.getElementById('cloudinary-category').value;
      
      await savePhoto({
        src: cloudinaryUploadedUrl,
        title,
        category
      }, 'insert');
      
      cloudinaryUploadedUrl = null;
      cloudinaryForm.style.display = 'none';
      document.getElementById('cloudinary-uploads').innerHTML = '';
      cloudinaryTitle.value = '';
    });
    </script>
    <script src="https://upload-widget.cloudinary.com/latest/global/all.js" type="text/javascript"></script>
  </body>
</html>
