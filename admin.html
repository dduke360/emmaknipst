<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Emma Knipst</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“·</text></svg>">
  <link rel="stylesheet" href="style.css">
  <style>
    :root {
      --admin-bg: #f2f2f7;
      --admin-surface: rgba(255, 255, 255, 0.92);
      --admin-surface-strong: #ffffff;
      --admin-text: #111114;
      --admin-muted: #6b6b73;
      --admin-border: rgba(17, 17, 20, 0.08);
      --admin-accent: #0a84ff;
      --admin-danger: #ff375f;
      --admin-success: #30d158;
      --admin-radius-lg: 22px;
      --admin-radius-md: 16px;
      --admin-radius-sm: 12px;
      --admin-shadow: 0 18px 40px rgba(25, 28, 35, 0.08);
    }

    [data-theme="dark"] {
      --admin-bg: #0a0a0d;
      --admin-surface: rgba(28, 28, 30, 0.9);
      --admin-surface-strong: #1c1c1e;
      --admin-text: #f5f5f7;
      --admin-muted: #a1a1aa;
      --admin-border: rgba(245, 245, 247, 0.12);
      --admin-accent: #64d2ff;
      --admin-danger: #ff6482;
      --admin-success: #4ee082;
      --admin-shadow: 0 20px 44px rgba(0, 0, 0, 0.42);
    }

    .admin-body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--admin-bg-custom, var(--admin-bg));
      color: var(--admin-text);
    }

    .admin-container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.2rem 1rem 2rem;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.95rem 1rem;
      border: 1px solid var(--admin-border);
      background: var(--admin-surface);
      border-radius: var(--admin-radius-lg);
      box-shadow: var(--admin-shadow);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .admin-header h1 {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      font-size: 1.04rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .header-actions {
      display: flex;
      gap: 0.55rem;
      align-items: center;
    }

    .btn {
      border: 1px solid var(--admin-border);
      border-radius: 999px;
      padding: 0.5rem 0.86rem;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      line-height: 1;
      font-family: inherit;
      transition: 180ms ease;
      background: var(--admin-surface);
      color: var(--admin-text);
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-primary {
      background: var(--admin-accent);
      color: #fff;
      border-color: var(--admin-accent);
    }

    .btn-secondary {
      background: var(--admin-surface-strong);
    }

    .btn-danger {
      background: transparent;
      color: var(--admin-danger);
      border-color: color-mix(in srgb, var(--admin-danger) 50%, var(--admin-border));
    }

    .btn-success {
      background: transparent;
      color: var(--admin-success);
      border-color: color-mix(in srgb, var(--admin-success) 50%, var(--admin-border));
    }

    .full-width {
      width: 100%;
      justify-content: center;
    }

    .theme-toggle-admin {
      min-width: 5rem;
    }

    .admin-section {
      background: var(--admin-surface);
      padding: 1rem;
      margin-bottom: 1.05rem;
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-lg);
      box-shadow: var(--admin-shadow);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .admin-section h2 {
      font-size: 0.95rem;
      margin-bottom: 0.7rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .section-note {
      font-size: 0.8rem;
      color: var(--admin-muted);
      margin-bottom: 0.9rem;
    }

    .form-group {
      margin-bottom: 0.85rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.8rem;
      color: var(--admin-muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea,
    .control-field {
      width: 100%;
      padding: 0.58rem 0.72rem;
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-sm);
      font-size: 0.86rem;
      background: var(--admin-surface-strong);
      color: var(--admin-text);
      font-family: inherit;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(148px, 1fr));
      gap: 0.7rem;
    }

    .photo-card {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-md);
      background: var(--admin-surface-strong);
    }

    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-card .delete-btn {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(0, 0, 0, 0.52);
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    .stats-card {
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-md);
      padding: 0.75rem;
      background: var(--admin-surface-strong);
    }

    .stat-title {
      color: var(--admin-muted);
      font-size: 0.74rem;
      margin-bottom: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .stats-row {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.48rem 0;
      border-bottom: 1px solid var(--admin-border);
      font-size: 0.83rem;
    }

    .stats-row:last-child {
      border-bottom: none;
    }

    .stat-rank {
      width: 20px;
      color: var(--admin-muted);
    }

    .stat-thumb {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      object-fit: cover;
    }

    .stat-name {
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .stat-value {
      color: var(--admin-muted);
    }

    .stat-value-like {
      color: var(--admin-accent);
    }

    .category-form {
      display: flex;
      gap: 0.55rem;
      align-items: flex-end;
    }

    .category-input-group {
      margin-bottom: 0;
      flex: 1;
    }

    .category-list {
      margin-top: 0.8rem;
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--admin-border);
      background: var(--admin-surface-strong);
      font-size: 0.75rem;
      margin: 0.18rem;
      gap: 0.35rem;
    }

    .category-remove {
      border: none;
      background: transparent;
      color: var(--admin-muted);
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .upload-preview {
      max-width: 200px;
      max-height: 150px;
      object-fit: contain;
      margin-bottom: 0.5rem;
      border-radius: 10px;
      border: 1px solid var(--admin-border);
    }

    .upload-success {
      font-size: 0.83rem;
      color: var(--admin-success);
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.55rem;
      margin-bottom: 0.5rem;
      max-width: 460px;
    }

    .color-group {
      margin-bottom: 0.8rem;
    }

    .color-group-title {
      font-size: 0.72rem;
      color: var(--admin-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.4rem;
    }

    .color-chip {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 999px;
      border: 2px solid var(--admin-border);
      cursor: pointer;
      background: transparent;
      transition: transform 150ms ease, border-color 150ms ease;
    }

    .color-chip:hover {
      transform: scale(1.05);
    }

    .color-chip.active {
      border-color: var(--admin-text);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--admin-text) 20%, transparent);
    }

    .color-help {
      font-size: 0.78rem;
      color: var(--admin-muted);
      margin-bottom: 0.75rem;
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .login-box {
      background: var(--admin-surface);
      padding: 1.35rem;
      border: 1px solid var(--admin-border);
      width: 100%;
      max-width: 380px;
      color: var(--admin-text);
      border-radius: var(--admin-radius-lg);
      box-shadow: var(--admin-shadow);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .login-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.1rem;
    }

    .login-box h1 {
      margin: 0;
      font-size: 1.08rem;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      font-weight: 700;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 860px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 620px) {
      .admin-container {
        padding: 0.9rem 0.65rem 1.5rem;
      }

      .admin-header {
        flex-direction: column;
        gap: 0.7rem;
        align-items: flex-start;
      }

      .category-form {
        flex-direction: column;
        align-items: stretch;
      }

      .color-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }
  </style>
</head>
<body class="admin-body">
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <div class="login-header">
        <h1>Admin Login</h1>
        <button id="theme-toggle-login" type="button" class="btn btn-secondary theme-toggle-admin">Dark</button>
      </div>
      <form id="login-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" autocomplete="email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" autocomplete="current-password" required>
        </div>
        <button type="submit" class="btn btn-primary full-width">Login</button>
      </form>
    </div>
  </div>

  <div id="admin-app" class="admin-container hidden">
    <div class="admin-header">
      <h1>Photo Admin</h1>
      <div class="header-actions">
        <button id="theme-toggle-admin" type="button" class="btn btn-secondary theme-toggle-admin">Dark</button>
        <button id="logout-btn" class="btn btn-secondary">Logout</button>
      </div>
    </div>

    <div class="admin-section">
      <h2>Upload to Cloudinary</h2>
      <p class="section-note">Upload images to Cloudinary (free cloud storage). Images persist across deployments.</p>
      <div id="cloudinary-uploads" class="category-list"></div>
      <button id="cloudinary-upload-btn" class="btn btn-primary">Upload Images</button>
      <div id="cloudinary-form" class="category-list" style="display: none;">
        <div class="form-group">
          <label>Title Prefix (optional)</label>
          <input type="text" id="cloudinary-title" placeholder="e.g. Paris Series">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="cloudinary-category"></select>
        </div>
        <button id="add-cloudinary-btn" class="btn btn-success">Add Uploads to Gallery</button>
      </div>
    </div>

    <div class="admin-section">
      <h2>Statistics</h2>
      <div class="stats-grid">
        <div class="stats-card">
          <h3 class="stat-title">Top 10 by Views</h3>
          <div id="top-views"></div>
        </div>
        <div class="stats-card">
          <h3 class="stat-title">Top 10 by Likes</h3>
          <div id="top-likes"></div>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <h2>Manage Categories</h2>
      <form id="add-category-form" class="category-form">
        <div class="form-group category-input-group">
          <label>New Category Name</label>
          <input type="text" id="new-category" placeholder="Category name">
        </div>
        <button type="submit" class="btn btn-secondary">Add</button>
      </form>
      <div id="category-list" class="category-list"></div>
    </div>

    <div class="admin-section">
      <h2>Background Color</h2>
      <p class="color-help">Choose a background color for the public site. 8 light presets and 8 dark presets.</p>
      <div id="background-palette"></div>
      <button id="save-background-btn" class="btn btn-primary">Save Background</button>
    </div>

    <div class="admin-section">
      <h2>All Photos</h2>
      <div id="photos-grid" class="photos-grid"></div>
    </div>

    <div class="admin-section">
      <h2>Edit About</h2>
      <form id="about-form">
        <div class="form-group">
          <label>About Text</label>
          <textarea id="about-text" rows="4" class="control-field"></textarea>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="about-email">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="about-instagram">
        </div>
        <button type="submit" class="btn btn-primary">Save About</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const THEME_KEY = 'emma_theme_mode';
    const LIGHT_COLORS = [
      '#f2f2f7', '#ffffff', '#f8f4ef', '#f6efe8',
      '#eef2f7', '#e9f3ff', '#eaf7f0', '#f7edf7'
    ];
    const DARK_COLORS = [
      '#2b2d31', '#1f2937', '#202a44', '#5a1e1e',
      '#1b4332', '#2c2438', '#3b2f1f', '#1e2a2f'
    ];
    const BACKGROUND_COLORS = [...LIGHT_COLORS, ...DARK_COLORS];
    const BACKGROUND_COLOR_GROUPS = [
      { title: 'Light Colors', colors: LIGHT_COLORS },
      { title: 'Dark Colors', colors: DARK_COLORS }
    ];
    const DEFAULT_CATEGORIES = [
      { id: 'portraits', name: 'Portraits' },
      { id: 'fashion', name: 'Fashion' },
      { id: 'lifestyle', name: 'Lifestyle' },
      { id: 'nature', name: 'Nature' }
    ];
    let data = null;
    let cloudinaryUploadedItems = [];
    let selectedBackgroundColor = BACKGROUND_COLORS[0];

    // Cloudinary config
    const CLOUDINARY_CLOUD_NAME = '%CLOUDINARY_CLOUD_NAME%';
    const CLOUDINARY_UPLOAD_PRESET = '%CLOUDINARY_UPLOAD_PRESET%';

    const loginScreen = document.getElementById('login-screen');
    const adminApp = document.getElementById('admin-app');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const addCategoryForm = document.getElementById('add-category-form');
    const photosGrid = document.getElementById('photos-grid');
    const categoryList = document.getElementById('category-list');
    const themeToggleLogin = document.getElementById('theme-toggle-login');
    const themeToggleAdmin = document.getElementById('theme-toggle-admin');
    const backgroundPalette = document.getElementById('background-palette');
    const saveBackgroundBtn = document.getElementById('save-background-btn');

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function normalizeHex(hex) {
      if (!hex) return null;
      let value = String(hex).trim().toLowerCase();
      if (!value.startsWith('#')) value = `#${value}`;
      if (/^#[0-9a-f]{3}$/.test(value)) {
        value = `#${value[1]}${value[1]}${value[2]}${value[2]}${value[3]}${value[3]}`;
      }
      return /^#[0-9a-f]{6}$/.test(value) ? value : null;
    }

    function hexToRgb(hex) {
      const n = normalizeHex(hex);
      if (!n) return null;
      const int = parseInt(n.slice(1), 16);
      return {
        r: (int >> 16) & 255,
        g: (int >> 8) & 255,
        b: int & 255
      };
    }

    function rgbToHex({ r, g, b }) {
      const toHex = (v) => clamp(Math.round(v), 0, 255).toString(16).padStart(2, '0');
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    function mixHex(a, b, t) {
      const c1 = hexToRgb(a);
      const c2 = hexToRgb(b);
      if (!c1 || !c2) return a;
      const ratio = clamp(t, 0, 1);
      return rgbToHex({
        r: c1.r + (c2.r - c1.r) * ratio,
        g: c1.g + (c2.g - c1.g) * ratio,
        b: c1.b + (c2.b - c1.b) * ratio
      });
    }

    function rgbToHsl({ r, g, b }) {
      const nr = r / 255;
      const ng = g / 255;
      const nb = b / 255;
      const max = Math.max(nr, ng, nb);
      const min = Math.min(nr, ng, nb);
      let h = 0;
      let s = 0;
      const l = (max + min) / 2;

      if (max !== min) {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case nr:
            h = ((ng - nb) / d + (ng < nb ? 6 : 0)) / 6;
            break;
          case ng:
            h = ((nb - nr) / d + 2) / 6;
            break;
          default:
            h = ((nr - ng) / d + 4) / 6;
        }
      }

      return { h, s, l };
    }

    function hslToRgb({ h, s, l }) {
      if (s === 0) {
        const v = Math.round(l * 255);
        return { r: v, g: v, b: v };
      }

      const hue2rgb = (p, q, t) => {
        let tt = t;
        if (tt < 0) tt += 1;
        if (tt > 1) tt -= 1;
        if (tt < 1 / 6) return p + (q - p) * 6 * tt;
        if (tt < 1 / 2) return q;
        if (tt < 2 / 3) return p + (q - p) * (2 / 3 - tt) * 6;
        return p;
      };

      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      return {
        r: Math.round(hue2rgb(p, q, h + 1 / 3) * 255),
        g: Math.round(hue2rgb(p, q, h) * 255),
        b: Math.round(hue2rgb(p, q, h - 1 / 3) * 255)
      };
    }

    function relativeLuminance(hex) {
      const rgb = hexToRgb(hex);
      if (!rgb) return 0;
      const toLinear = (v) => {
        const srgb = v / 255;
        return srgb <= 0.04045 ? srgb / 12.92 : ((srgb + 0.055) / 1.055) ** 2.4;
      };
      const r = toLinear(rgb.r);
      const g = toLinear(rgb.g);
      const b = toLinear(rgb.b);
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    function derivePalette(bgHex) {
      const bg = normalizeHex(bgHex);
      if (!bg) return null;

      const lum = relativeLuminance(bg);
      const isDark = lum < 0.34;
      const text = isDark ? '#f5f5f7' : '#111114';
      const white = '#ffffff';

      const surface = isDark ? mixHex(bg, white, 0.1) : mixHex(bg, white, 0.72);
      const surfaceStrong = isDark ? mixHex(bg, white, 0.14) : mixHex(bg, white, 0.86);
      const muted = mixHex(text, bg, isDark ? 0.46 : 0.56);
      const border = mixHex(text, bg, isDark ? 0.72 : 0.84);

      const hsl = rgbToHsl(hexToRgb(bg));
      const accentHsl = {
        h: (hsl.h + (isDark ? 0.06 : 0.08)) % 1,
        s: clamp(hsl.s + 0.22, 0.2, 0.92),
        l: isDark ? clamp(hsl.l + 0.34, 0.58, 0.76) : clamp(hsl.l - 0.22, 0.28, 0.52)
      };
      const accent = rgbToHex(hslToRgb(accentHsl));

      return {
        bg,
        surface,
        surfaceStrong,
        text,
        muted,
        border,
        accent,
        shadow: isDark ? '0 20px 44px rgba(0,0,0,0.42)' : '0 18px 40px rgba(25,28,35,0.08)'
      };
    }

    let currentThemeMode = 'color';
    setupTheme();

    function setupTheme() {
      const storedMode = localStorage.getItem(THEME_KEY);
      const initialMode = storedMode === 'light' ? 'light' : 'color';
      applyThemeMode(initialMode);

      [themeToggleLogin, themeToggleAdmin].forEach(toggle => {
        if (!toggle) return;
        toggle.addEventListener('click', () => {
          const next = currentThemeMode === 'color' ? 'light' : 'color';
          applyThemeMode(next);
          localStorage.setItem(THEME_KEY, next);
        });
      });
    }

    function applyThemeMode(mode) {
      currentThemeMode = mode;
      document.documentElement.setAttribute('data-theme', 'light');
      applyAdminBackground(mode === 'color' ? selectedBackgroundColor : null);
      const label = mode === 'color' ? 'Light' : 'Color';
      [themeToggleLogin, themeToggleAdmin].forEach(toggle => {
        if (!toggle) return;
        toggle.textContent = label;
        toggle.setAttribute('aria-label', mode === 'color' ? 'Switch to light mode' : 'Switch to color mode');
      });
    }

    function applyAdminBackground(color) {
      const palette = derivePalette(color);
      const root = document.documentElement;

      if (!palette) {
        [
          '--admin-bg-custom', '--admin-surface', '--admin-surface-strong', '--admin-text',
          '--admin-muted', '--admin-border', '--admin-accent', '--admin-shadow'
        ].forEach(v => root.style.removeProperty(v));
        return;
      }

      root.style.setProperty('--admin-bg-custom', palette.bg);
      root.style.setProperty('--admin-surface', palette.surface);
      root.style.setProperty('--admin-surface-strong', palette.surfaceStrong);
      root.style.setProperty('--admin-text', palette.text);
      root.style.setProperty('--admin-muted', palette.muted);
      root.style.setProperty('--admin-border', palette.border);
      root.style.setProperty('--admin-accent', palette.accent);
      root.style.setProperty('--admin-shadow', palette.shadow);
    }

    function renderBackgroundPicker() {
      backgroundPalette.innerHTML = '';
      BACKGROUND_COLOR_GROUPS.forEach(group => {
        const groupWrap = document.createElement('div');
        groupWrap.className = 'color-group';

        const title = document.createElement('div');
        title.className = 'color-group-title';
        title.textContent = group.title;
        groupWrap.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'color-grid';

        group.colors.forEach(color => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = `color-chip ${selectedBackgroundColor === color ? 'active' : ''}`;
          chip.style.background = color;
          chip.title = color;
          chip.setAttribute('aria-label', `Background color ${color}`);
          chip.addEventListener('click', () => {
            selectedBackgroundColor = color;
            if (currentThemeMode === 'color') {
              applyAdminBackground(color);
            }
            renderBackgroundPicker();
          });
          grid.appendChild(chip);
        });

        groupWrap.appendChild(grid);
        backgroundPalette.appendChild(groupWrap);
      });
    }

    async function initAuth() {
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) {
        console.error('Session check failed:', error);
        return;
      }
      if (data && data.session) {
        loginScreen.classList.add('hidden');
        adminApp.classList.remove('hidden');
        loadData();
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (!error) {
        loginScreen.classList.add('hidden');
        adminApp.classList.remove('hidden');
        loadData();
      } else {
        console.error('Login failed:', error);
        alert('Login failed. Check email/password.');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = '/index.html';
    });

    async function loadData() {
      try {
        // Load photos from Supabase
        const { data: photos, error: photosError } = await supabaseClient
          .from('photos')
          .select('*')
          .order('created_at', { ascending: false });

        if (photosError) throw photosError;

        // Load settings from Supabase
        const { data: settings, error: settingsError } = await supabaseClient
          .from('settings')
          .select('*');

        if (settingsError) throw settingsError;

        // Convert settings to photographer object
        const settingsObj = {};
        settings.forEach(s => {
          settingsObj[s.key] = s.value;
        });

        let parsedCategories = [...DEFAULT_CATEGORIES];
        if (settingsObj.categories) {
          try {
            const parsed = JSON.parse(settingsObj.categories);
            if (Array.isArray(parsed) && parsed.length) {
              parsedCategories = parsed.filter(c => c && c.id && c.name);
            }
          } catch (e) {
            console.warn('Invalid categories setting JSON, using defaults.');
          }
        }

        data = {
          photographer: {
            about: settingsObj.about || '',
            email: settingsObj.email || '',
            instagram: settingsObj.instagram || '',
            backgroundColor: settingsObj.background_color || BACKGROUND_COLORS[0]
          },
          categories: parsedCategories,
          photos: photos || []
        };

        // Also save to localStorage as backup
        localStorage.setItem('emma_photos', JSON.stringify(data));
        selectedBackgroundColor = data.photographer.backgroundColor || BACKGROUND_COLORS[0];
        applyThemeMode(currentThemeMode);

        render();
      } catch (error) {
        console.error('Failed to load from Supabase:', error);
        // Fallback to localStorage
        const stored = localStorage.getItem('emma_photos');
        if (stored) {
          data = JSON.parse(stored);
          selectedBackgroundColor = (data.photographer && data.photographer.backgroundColor) || BACKGROUND_COLORS[0];
          applyThemeMode(currentThemeMode);
          render();
        } else {
          alert('Failed to load data. Check console for details.');
        }
      }
    }

    async function savePhoto(photo, action = 'insert') {
      try {
        if (action === 'delete') {
          const { error } = await supabaseClient.from('photos').delete().eq('id', photo.id);
          if (error) throw error;
        } else if (action === 'insert') {
          const { error } = await supabaseClient.from('photos').insert([{
            title: photo.title,
            src: photo.src,
            category: photo.category
          }]);
          if (error) throw error;
        }
        
        // Reload data after save
        await loadData();
      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save. Check console for details.');
      }
    }

    async function savePhotosBulk(photosToInsert) {
      if (!photosToInsert.length) return;
      try {
        const { error } = await supabaseClient.from('photos').insert(photosToInsert);
        if (error) throw error;
        await loadData();
      } catch (error) {
        console.error('Bulk save error:', error);
        alert('Failed to save uploads. Check console for details.');
      }
    }

    async function saveSetting(key, value) {
      try {
        const { error } = await supabaseClient
          .from('settings')
          .upsert({ key, value }, { onConflict: 'key' });
        
        if (error) throw error;
      } catch (error) {
        console.error('Save setting error:', error);
      }
    }

    async function saveData() {
      await saveSetting('categories', JSON.stringify(data.categories));
      // Save to localStorage as immediate feedback
      localStorage.setItem('emma_photos', JSON.stringify(data));
      render();
    }

    function render() {
      renderCategories();
      renderPhotos();
      renderAboutForm();
      renderStats();
      renderBackgroundPicker();
    }

    function renderStats() {
      const photos = data.photos || [];
      
      // Sort by views
      const byViews = [...photos].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 10);
      // Sort by likes
      const byLikes = [...photos].sort((a, b) => (b.likes || 0) - (a.likes || 0)).slice(0, 10);
      
      document.getElementById('top-views').innerHTML = byViews.map((p, i) => `
        <div class="stats-row">
          <span class="stat-rank">${i + 1}.</span>
          <img class="stat-thumb" src="${p.src}" alt="${p.title}">
          <span class="stat-name">${p.title}</span>
          <span class="stat-value">${p.views || 0} views</span>
        </div>
      `).join('');
      
      document.getElementById('top-likes').innerHTML = byLikes.map((p, i) => `
        <div class="stats-row">
          <span class="stat-rank">${i + 1}.</span>
          <img class="stat-thumb" src="${p.src}" alt="${p.title}">
          <span class="stat-name">${p.title}</span>
          <span class="stat-value stat-value-like">â™¥ ${p.likes || 0}</span>
        </div>
      `).join('');
    }

    function renderCategories() {
      categoryList.innerHTML = '';
      document.getElementById('cloudinary-category').innerHTML = '';
      
      data.categories.forEach(cat => {
        const tag = document.createElement('span');
        tag.className = 'category-tag';
        tag.innerHTML = `${cat.name} <button class="category-remove" onclick="deleteCategory('${cat.id}')">&times;</button>`;
        categoryList.appendChild(tag);

        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        document.getElementById('cloudinary-category').appendChild(option);
      });
    }

    function renderPhotos() {
      photosGrid.innerHTML = '';
      data.photos.forEach(photo => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
          <img src="${photo.src}" alt="${photo.title}">
          <button class="delete-btn" onclick="deletePhoto(${photo.id})">&times;</button>
        `;
        photosGrid.appendChild(card);
      });
    }

    function renderAboutForm() {
      document.getElementById('about-text').value = data.photographer.about || '';
      document.getElementById('about-email').value = data.photographer.email || '';
      document.getElementById('about-instagram').value = data.photographer.instagram || '';
    }

    document.getElementById('about-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const about = document.getElementById('about-text').value;
      const email = document.getElementById('about-email').value;
      const instagram = document.getElementById('about-instagram').value;
      
      // Save to Supabase
      await saveSetting('about', about);
      await saveSetting('email', email);
      await saveSetting('instagram', instagram);
      
      // Update local data
      data.photographer.about = about;
      data.photographer.email = email;
      data.photographer.instagram = instagram;
      localStorage.setItem('emma_photos', JSON.stringify(data));
      
      alert('About saved to cloud!');
    });

    saveBackgroundBtn.addEventListener('click', async () => {
      await saveSetting('background_color', selectedBackgroundColor);
      data.photographer.backgroundColor = selectedBackgroundColor;
      localStorage.setItem('emma_photos', JSON.stringify(data));
      alert('Background color saved!');
    });

    addCategoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('new-category').value.trim();
      if (name) {
        const id = name.toLowerCase().replace(/\s+/g, '-');
        if (!data.categories.find(c => c.id === id)) {
          data.categories.push({ id, name });
          await saveData();
        }
        document.getElementById('new-category').value = '';
      }
    });

    window.deletePhoto = async (id) => {
      if (confirm('Delete this photo?')) {
        const photo = data.photos.find(p => p.id === id);
        if (photo) {
          await savePhoto(photo, 'delete');
        }
      }
    };

    window.deleteCategory = async (id) => {
      if (confirm('Delete this category? Photos will need a new category.')) {
        data.categories = data.categories.filter(c => c.id !== id);
        await saveData();
      }
    };

    // Cloudinary upload functionality
    const cloudinaryUploadBtn = document.getElementById('cloudinary-upload-btn');
    const cloudinaryForm = document.getElementById('cloudinary-form');
    const cloudinaryTitle = document.getElementById('cloudinary-title');
    const addCloudinaryBtn = document.getElementById('add-cloudinary-btn');

    function openCloudinaryWidget() {
      if (typeof cloudinary === 'undefined') {
        alert('Cloudinary widget not loaded. Check console (F12) for errors.');
        return;
      }

      if (
        CLOUDINARY_CLOUD_NAME.includes('%') ||
        CLOUDINARY_UPLOAD_PRESET.includes('%')
      ) {
        alert('Please configure Cloudinary in admin.html. See instructions in CLOUDINARY_SETUP.md');
        return;
      }

      try {
        cloudinary.openUploadWidget({
        cloud_name: CLOUDINARY_CLOUD_NAME,
        upload_preset: CLOUDINARY_UPLOAD_PRESET,
        sources: ['local', 'url', 'camera'],
        multiple: true,
        maxFiles: 30,
        folder: 'emma_knipst'
      }, (error, result) => {
        if (error) {
          console.error('Cloudinary error:', error);
          alert('Upload failed. Check console for details.');
          return;
        }
        if (result && result.event === 'success') {
          cloudinaryUploadedItems.push({
            src: result.info.secure_url,
            originalFilename: result.info.original_filename || 'Untitled'
          });
        }
        if (result && result.event === 'queues-end') {
          if (!cloudinaryUploadedItems.length) return;
          const previewHtml = cloudinaryUploadedItems.slice(0, 6).map(item =>
            `<img src="${item.src}" alt="Uploaded preview" class="upload-preview">`
          ).join('');
          document.getElementById('cloudinary-uploads').innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5rem;">${previewHtml}</div>
            <p class="upload-success">${cloudinaryUploadedItems.length} image(s) uploaded successfully.</p>
          `;
          cloudinaryForm.style.display = 'block';
        }
      });
      } catch (e) {
        console.error('Widget error:', e);
        alert('Error opening widget: ' + e.message);
      }
    }

    cloudinaryUploadBtn.addEventListener('click', openCloudinaryWidget);

    addCloudinaryBtn.addEventListener('click', async () => {
      if (!cloudinaryUploadedItems.length) return;
      
      const titlePrefix = cloudinaryTitle.value.trim();
      const category = document.getElementById('cloudinary-category').value;

      const payload = cloudinaryUploadedItems.map((item, index) => {
        const title = titlePrefix
          ? `${titlePrefix}${cloudinaryUploadedItems.length > 1 ? ` ${index + 1}` : ''}`
          : item.originalFilename;
        return {
          src: item.src,
          title,
          category
        };
      });

      await savePhotosBulk(payload);

      cloudinaryUploadedItems = [];
      cloudinaryForm.style.display = 'none';
      document.getElementById('cloudinary-uploads').innerHTML = '';
      cloudinaryTitle.value = '';
    });
    initAuth();
    </script>
    <script src="https://upload-widget.cloudinary.com/latest/global/all.js" type="text/javascript"></script>
  </body>
</html>
