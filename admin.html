<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Emma Knipst</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #000; color: #fff; }
    .admin-container { max-width: 1000px; margin: 0 auto; padding: 2rem; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .admin-header h1 { font-size: 1.5rem; font-weight: 400; }
    .btn { padding: 0.5rem 1rem; border: none; cursor: pointer; font-size: 0.9rem; }
    .btn-primary { background: #fff; color: #000; }
    .btn-secondary { background: #262626; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    
    .admin-section { background: #121212; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #363636; }
    .admin-section h2 { font-size: 1.1rem; margin-bottom: 1rem; font-weight: 500; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: #a8a8a8; }
    .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #363636; font-size: 0.9rem; background: #121212; color: #fff; }
    
    .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .photo-card { position: relative; aspect-ratio: 1; overflow: hidden; border: 1px solid #363636; }
    .photo-card img { width: 100%; height: 100%; object-fit: cover; }
    .photo-card .delete-btn { position: absolute; top: 0.25rem; right: 0.25rem; background: rgba(220,53,69,0.9); color: #fff; border: none; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; }
    
    .category-tag { display: inline-block; padding: 0.25rem 0.5rem; background: #262626; font-size: 0.75rem; margin: 0.25rem; }
    
    .json-output { width: 100%; height: 300px; font-family: monospace; font-size: 0.8rem; padding: 1rem; border: 1px solid #363636; background: #121212; color: #fff; }
    
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; }
    .login-box { background: #121212; padding: 2rem; border: 1px solid #363636; width: 100%; max-width: 350px; color: #fff; }
    .login-box h1 { font-size: 1.25rem; margin-bottom: 1.5rem; text-align: center; }
    .login-box input { background: #121212; color: #fff; border: 1px solid #363636; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>Admin Login</h1>
      <form id="login-form">
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
      </form>
    </div>
  </div>

  <div id="admin-app" class="admin-container hidden">
    <div class="admin-header">
      <h1>Photo Admin</h1>
      <button id="logout-btn" class="btn btn-secondary">Logout</button>
    </div>

    <div class="admin-section">
      <h2>Upload to Cloudinary</h2>
      <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Upload images to Cloudinary (free cloud storage). Images persist across all deployments.</p>
      <div id="cloudinary-uploads" style="margin-bottom: 1rem;"></div>
      <button id="cloudinary-upload-btn" class="btn btn-primary">Upload Image</button>
      <div id="cloudinary-form" style="margin-top: 1rem; display: none;">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="cloudinary-title" placeholder="Photo title">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="cloudinary-category"></select>
        </div>
        <button id="add-cloudinary-btn" class="btn btn-success">Add to Gallery</button>
      </div>
    </div>

    <div class="admin-section">
      <h2>Edit About</h2>
      <form id="about-form">
        <div class="form-group">
          <label>About Text</label>
          <textarea id="about-text" rows="4" style="width: 100%; padding: 0.5rem; border: 1px solid #363636; font-size: 0.9rem; background: #121212; color: #fff;"></textarea>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="about-email" style="width: 100%; padding: 0.5rem; border: 1px solid #363636; font-size: 0.9rem; background: #121212; color: #fff;">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="about-instagram" style="width: 100%; padding: 0.5rem; border: 1px solid #363636; font-size: 0.9rem; background: #121212; color: #fff;">
        </div>
        <button type="submit" class="btn btn-primary">Save About</button>
      </form>
    </div>

    <div class="admin-section">
      <h2>Manage Categories</h2>
      <form id="add-category-form" style="display: flex; gap: 0.5rem; align-items: flex-end;">
        <div class="form-group" style="margin-bottom: 0; flex: 1;">
          <label>New Category Name</label>
          <input type="text" id="new-category" placeholder="Category name">
        </div>
        <button type="submit" class="btn btn-secondary">Add</button>
      </form>
      <div id="category-list" style="margin-top: 1rem;"></div>
    </div>

    <div class="admin-section">
      <h2>All Photos</h2>
      <div id="photos-grid" class="photos-grid"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const ADMIN_PASSWORD = 'emma2026';
    let data = null;
    let cloudinaryUploadedUrl = null;

    // Cloudinary config
    const CLOUDINARY_CLOUD_NAME = 'djoh49z3m';
    const CLOUDINARY_UPLOAD_PRESET = 'emmaknipst';

    const loginScreen = document.getElementById('login-screen');
    const adminApp = document.getElementById('admin-app');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const addCategoryForm = document.getElementById('add-category-form');
    const photosGrid = document.getElementById('photos-grid');
    const categoryList = document.getElementById('category-list');
  

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      if (password === ADMIN_PASSWORD) {
        loginScreen.classList.add('hidden');
        adminApp.classList.remove('hidden');
        loadData();
      } else {
        alert('Incorrect password');
      }
    });

    logoutBtn.addEventListener('click', () => {
      loginScreen.classList.remove('hidden');
      adminApp.classList.add('hidden');
      document.getElementById('password').value = '';
    });

    async function loadData() {
      try {
        // Load photos from Supabase
        const { data: photos, error: photosError } = await supabaseClient
          .from('photos')
          .select('*')
          .order('created_at', { ascending: false });

        if (photosError) throw photosError;

        // Load settings from Supabase
        const { data: settings, error: settingsError } = await supabaseClient
          .from('settings')
          .select('*');

        if (settingsError) throw settingsError;

        // Convert settings to photographer object
        const settingsObj = {};
        settings.forEach(s => {
          settingsObj[s.key] = s.value;
        });

        data = {
          photographer: {
            about: settingsObj.about || '',
            email: settingsObj.email || '',
            instagram: settingsObj.instagram || ''
          },
          categories: [
            { id: 'portraits', name: 'Portraits' },
            { id: 'fashion', name: 'Fashion' },
            { id: 'lifestyle', name: 'Lifestyle' },
            { id: 'nature', name: 'Nature' }
          ],
          photos: photos || []
        };

        // Also save to localStorage as backup
        localStorage.setItem('emma_photos', JSON.stringify(data));

        render();
      } catch (error) {
        console.error('Failed to load from Supabase:', error);
        // Fallback to localStorage
        const stored = localStorage.getItem('emma_photos');
        if (stored) {
          data = JSON.parse(stored);
          render();
        } else {
          alert('Failed to load data. Check console for details.');
        }
      }
    }

    async function savePhoto(photo, action = 'insert') {
      try {
        if (action === 'delete') {
          const { error } = await supabaseClient.from('photos').delete().eq('id', photo.id);
          if (error) throw error;
        } else if (action === 'insert') {
          const { error } = await supabaseClient.from('photos').insert([{
            title: photo.title,
            src: photo.src,
            category: photo.category
          }]);
          if (error) throw error;
        }
        
        // Reload data after save
        await loadData();
      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save. Check console for details.');
      }
    }

    async function saveSetting(key, value) {
      try {
        const { error } = await supabaseClient
          .from('settings')
          .upsert({ key, value }, { onConflict: 'key' });
        
        if (error) throw error;
      } catch (error) {
        console.error('Save setting error:', error);
      }
    }

    async function saveData() {
      // Save to localStorage as immediate feedback
      localStorage.setItem('emma_photos', JSON.stringify(data));
      render();
    }

    function render() {
      renderCategories();
      renderPhotos();
      renderAboutForm();
    }

    function renderCategories() {
      categoryList.innerHTML = '';
      document.getElementById('cloudinary-category').innerHTML = '';
      
      data.categories.forEach(cat => {
        const tag = document.createElement('span');
        tag.className = 'category-tag';
        tag.innerHTML = `${cat.name} <button onclick="deleteCategory('${cat.id}')" style="border:none;background:none;cursor:pointer;margin-left:4px;">&times;</button>`;
        categoryList.appendChild(tag);

        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        document.getElementById('cloudinary-category').appendChild(option);
      });
    }

    function renderPhotos() {
      photosGrid.innerHTML = '';
      data.photos.forEach(photo => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
          <img src="${photo.src}" alt="${photo.title}">
          <button class="delete-btn" onclick="deletePhoto(${photo.id})">&times;</button>
        `;
        photosGrid.appendChild(card);
      });
    }

    function renderAboutForm() {
      document.getElementById('about-text').value = data.photographer.about || '';
      document.getElementById('about-email').value = data.photographer.email || '';
      document.getElementById('about-instagram').value = data.photographer.instagram || '';
    }

    document.getElementById('about-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const about = document.getElementById('about-text').value;
      const email = document.getElementById('about-email').value;
      const instagram = document.getElementById('about-instagram').value;
      
      // Save to Supabase
      await saveSetting('about', about);
      await saveSetting('email', email);
      await saveSetting('instagram', instagram);
      
      // Update local data
      data.photographer.about = about;
      data.photographer.email = email;
      data.photographer.instagram = instagram;
      localStorage.setItem('emma_photos', JSON.stringify(data));
      
      alert('About saved to cloud!');
    });

    addCategoryForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('new-category').value.trim();
      if (name) {
        const id = name.toLowerCase().replace(/\s+/g, '-');
        if (!data.categories.find(c => c.id === id)) {
          data.categories.push({ id, name });
          saveData();
        }
        document.getElementById('new-category').value = '';
      }
    });

    window.deletePhoto = async (id) => {
      if (confirm('Delete this photo?')) {
        const photo = data.photos.find(p => p.id === id);
        if (photo) {
          await savePhoto(photo, 'delete');
        }
      }
    };

    window.deleteCategory = (id) => {
      if (confirm('Delete this category? Photos will need a new category.')) {
        data.categories = data.categories.filter(c => c.id !== id);
        saveData();
      }
    };

    // Cloudinary upload functionality
    const cloudinaryUploadBtn = document.getElementById('cloudinary-upload-btn');
    const cloudinaryForm = document.getElementById('cloudinary-form');
    const cloudinaryTitle = document.getElementById('cloudinary-title');
    const addCloudinaryBtn = document.getElementById('add-cloudinary-btn');

    function openCloudinaryWidget() {
      if (typeof cloudinary === 'undefined') {
        alert('Cloudinary widget not loaded. Check console (F12) for errors.');
        return;
      }

      if (CLOUDINARY_CLOUD_NAME === 'YOUR_CLOUD_NAME' || CLOUDINARY_UPLOAD_PRESET === 'YOUR_UPLOAD_PRESET') {
        alert('Please configure Cloudinary in admin.html. See instructions in CLOUDINARY_SETUP.md');
        return;
      }

      try {
        cloudinary.openUploadWidget({
        cloud_name: CLOUDINARY_CLOUD_NAME,
        upload_preset: CLOUDINARY_UPLOAD_PRESET,
        sources: ['local', 'url', 'camera'],
        multiple: false,
        folder: 'emma_knipst'
      }, (error, result) => {
        if (error) {
          console.error('Cloudinary error:', error);
          alert('Upload failed. Check console for details.');
          return;
        }
        if (result && result.event === 'success') {
          cloudinaryUploadedUrl = result.info.secure_url;
          document.getElementById('cloudinary-uploads').innerHTML = `
            <img src="${cloudinaryUploadedUrl}" style="max-width: 200px; max-height: 150px; object-fit: contain; margin-bottom: 0.5rem;">
            <p style="font-size: 0.85rem; color: #28a745;">Uploaded successfully!</p>
          `;
          cloudinaryForm.style.display = 'block';
          cloudinaryTitle.value = result.info.original_filename || 'Untitled';
        }
      });
      } catch (e) {
        console.error('Widget error:', e);
        alert('Error opening widget: ' + e.message);
      }
    }

    cloudinaryUploadBtn.addEventListener('click', openCloudinaryWidget);

    addCloudinaryBtn.addEventListener('click', async () => {
      if (!cloudinaryUploadedUrl) return;
      
      const title = cloudinaryTitle.value.trim() || 'Untitled';
      const category = document.getElementById('cloudinary-category').value;
      
      await savePhoto({
        src: cloudinaryUploadedUrl,
        title,
        category
      }, 'insert');
      
      cloudinaryUploadedUrl = null;
      cloudinaryForm.style.display = 'none';
      document.getElementById('cloudinary-uploads').innerHTML = '';
      cloudinaryTitle.value = '';
    });
    </script>
    <script src="https://upload-widget.cloudinary.com/latest/global/all.js" type="text/javascript"></script>
  </body>
</html>
